<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dapur AI - SmartKitchen</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .typing-loader::after {
            content: "Menunggu Chef...";
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: "Meracik bumbu..."; }
            40% { content: "Memanaskan wajan..."; }
            60% { content: "Menulis resep..."; }
            80%, 100% { content: "Menghidangkan..."; }
        }
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

<nav class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <a href="/dashboard" class="flex items-center gap-2">
            <i class="fa-solid fa-kitchen-set text-orange-500 text-2xl"></i>
            <span class="text-xl font-bold tracking-tight text-gray-800">Smart<span class="text-orange-500">Kitchen</span></span>
        </a>

        <div class="flex items-center gap-4">
            <div class="hidden md:flex flex-col text-right mr-2">
                <span class="text-xs text-gray-500">Login sebagai</span>
                <span id="nav-username" class="text-sm font-bold text-gray-800">User</span>
            </div>
            <div class="h-8 w-8 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 font-bold border border-orange-200">
                <i class="fa-solid fa-user"></i>
            </div>
            <button onclick="handleLogout()" class="text-gray-400 hover:text-red-500 transition ml-2" title="Keluar">
                <i class="fa-solid fa-right-from-bracket text-xl"></i>
            </button>
        </div>
    </div>
</nav>

<main class="flex-grow container mx-auto px-4 py-8">

    <div id="toast" class="fixed top-20 right-5 z-50 transform translate-x-full transition-transform duration-300">
        <div id="toast-content" class="px-6 py-4 rounded-lg shadow-xl text-white font-medium flex items-center gap-3"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

        <div class="lg:col-span-5 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-100 sticky top-24">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-gray-800">
                    <i class="fa-solid fa-basket-shopping text-orange-500"></i> Pilih Bahan
                </h3>

                <div class="relative mb-4">
                    <input type="text" id="search-input" onkeyup="filterIngredients()" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none transition" placeholder="Cari bahan (ex: Telur)...">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                </div>

                <div class="mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Bahan Tersedia</div>
                <div id="ingredient-pool" class="flex flex-wrap gap-2 max-h-48 overflow-y-auto custom-scroll p-1 border rounded-lg bg-gray-50 min-h-[100px]">
                </div>

                <div class="mt-4 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider flex justify-between">
                    <span>Keranjang Masak</span>
                    <button onclick="clearSelection()" class="text-red-500 hover:text-red-700 text-xs">Reset</button>
                </div>
                <div id="selected-pool" class="min-h-[60px] bg-orange-50 rounded-xl p-3 flex flex-wrap gap-2 border border-orange-100">
                    <span id="placeholder-text" class="text-gray-400 text-sm italic w-full text-center self-center">Belum ada bahan dipilih...</span>
                </div>

                <input type="hidden" id="final-ingredients">

                <div class="mt-6">
                    <label class="block text-xs font-semibold text-gray-400 uppercase mb-2">Mode Masak</label>
                    <div class="flex gap-2 bg-gray-100 p-1 rounded-lg">
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="mode" value="normal" checked class="peer hidden">
                            <div class="py-2 text-center rounded-md text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:text-orange-600 peer-checked:shadow-sm transition">Normal</div>
                        </label>
                        <label class="cursor-pointer flex-1">
                            <input type="radio" name="mode" value="diet" class="peer hidden">
                            <div class="py-2 text-center rounded-md text-sm font-medium text-gray-500 peer-checked:bg-white peer-checked:text-green-600 peer-checked:shadow-sm transition">Diet Sehat</div>
                        </label>
                    </div>
                </div>

                <button onclick="generateRecipe()" id="btn-generate" class="w-full mt-6 py-3 bg-gray-900 text-white font-bold rounded-xl shadow-lg hover:bg-gray-800 transition transform hover:-translate-y-1 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-wand-magic-sparkles text-orange-400"></i> Buat Resep Sekarang
                </button>
            </div>
        </div>

        <div class="lg:col-span-7 space-y-8">

            <div class="relative min-h-[500px]">

                <div id="state-placeholder" class="bg-white border-2 border-dashed border-gray-300 rounded-2xl h-full flex flex-col justify-center items-center text-center p-12 text-gray-400 absolute inset-0">
                    <i class="fa-solid fa-plate-wheat text-6xl mb-4 opacity-30"></i>
                    <h3 class="text-lg font-semibold text-gray-500">Siap Memasak?</h3>
                    <p class="text-sm max-w-xs">Pilih bahan di panel kiri, lalu tekan tombol buat resep untuk melihat keajaiban AI.</p>
                </div>

                <div id="state-loading" class="hidden bg-white rounded-2xl shadow-lg h-full flex flex-col justify-center items-center text-center p-12 absolute inset-0 z-10">
                    <div class="animate-spin w-16 h-16 border-4 border-orange-100 border-t-orange-500 rounded-full mb-6"></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Chef AI Sedang Bekerja</h3>
                    <p class="text-gray-500 font-medium typing-loader animate-pulse">Sedang memproses...</p>
                    <div class="mt-8 flex gap-2 justify-center">
                        <span class="h-2 w-2 bg-orange-400 rounded-full animate-bounce"></span>
                        <span class="h-2 w-2 bg-orange-400 rounded-full animate-bounce delay-100"></span>
                        <span class="h-2 w-2 bg-orange-400 rounded-full animate-bounce delay-200"></span>
                    </div>
                </div>

                <div id="state-result" class="hidden bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden relative z-0">
                    <div class="bg-gradient-to-r from-orange-50 to-white px-6 py-4 border-b border-orange-100 flex justify-between items-center sticky top-0 bg-white/95 backdrop-blur z-20">
                        <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa-solid fa-scroll text-orange-500"></i> Hasil Resep
                        </h2>
                        <button onclick="toggleFavorite()" id="btn-fav" class="h-10 w-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-400 hover:text-red-500 hover:border-red-200 hover:bg-red-50 transition shadow-sm">
                            <i class="fa-regular fa-heart text-xl transition"></i>
                        </button>
                    </div>

                    <div class="p-8 prose prose-orange max-w-none text-gray-700 leading-relaxed" id="recipe-content">
                    </div>
                </div>
            </div>

            <div class="mt-12">
                <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center gap-2 border-b pb-4">
                    <i class="fa-solid fa-clock-rotate-left text-orange-500"></i> Riwayat Masakan
                </h3>
                <div id="history-list" class="space-y-4">
                </div>
                <div id="history-empty" class="hidden text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
                    <p class="text-gray-400">Belum ada riwayat. Ayo mulai masak!</p>
                </div>
            </div>

        </div>
    </div>
</main>

<footer class="bg-white border-t py-8 text-center text-gray-500 text-sm mt-12">
    <p>&copy; 2026 SmartKitchen AI - Final Project</p>
</footer>

<script>
    // --- DATA BAHAN ---
    const INGREDIENTS_DB = [
        "Ayam", "Sapi", "Telur", "Tahu", "Tempe", "Ikan", "Udang", "Cumi",
        "Bawang Merah", "Bawang Putih", "Cabai", "Tomat", "Wortel", "Kentang",
        "Bayam", "Kangkung", "Kol", "Brokoli", "Jagung", "Buncis", "Terong",
        "Kecap Manis", "Saus Tiram", "Santan", "Tepung Terigu", "Tepung Beras",
        "Mie", "Nasi", "Garam", "Gula", "Merica", "Jahe", "Kunyit", "Lengkuas"
    ];

    const state = {
        selected: new Set(),
        lastRecipeId: null
    };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        // Set Username dari Session Storage (kalau ada)
        const user = sessionStorage.getItem('username');
        if(user) document.getElementById('nav-username').innerText = user;

        renderIngredientPool();
        loadHistory();
    });

    // --- INGREDIENT LOGIC ---
    function renderIngredientPool(filter = "") {
        const pool = document.getElementById('ingredient-pool');
        pool.innerHTML = "";

        INGREDIENTS_DB.filter(i => i.toLowerCase().includes(filter.toLowerCase())).forEach(ing => {
            const isSel = state.selected.has(ing);
            const btn = document.createElement('button');
            btn.className = isSel
                ? "px-3 py-1.5 text-xs font-medium bg-orange-500 text-white rounded-full transition shadow-sm"
                : "px-3 py-1.5 text-xs font-medium bg-white border border-gray-200 text-gray-600 rounded-full hover:border-orange-300 hover:text-orange-500 transition";
            btn.innerText = ing;
            btn.onclick = () => toggleIngredient(ing);
            pool.appendChild(btn);
        });
    }

    function filterIngredients() {
        const q = document.getElementById('search-input').value;
        renderIngredientPool(q);
    }

    function toggleIngredient(ing) {
        if (state.selected.has(ing)) state.selected.delete(ing);
        else state.selected.add(ing);
        updateUI();
    }

    function clearSelection() {
        state.selected.clear();
        updateUI();
    }

    function updateUI() {
        const box = document.getElementById('selected-pool');
        const ph = document.getElementById('placeholder-text');
        const input = document.getElementById('final-ingredients');

        // Clear current tags except placeholder
        Array.from(box.children).forEach(c => { if(c.id !== 'placeholder-text') box.removeChild(c) });

        if (state.selected.size === 0) {
            ph.classList.remove('hidden');
        } else {
            ph.classList.add('hidden');
            state.selected.forEach(ing => {
                const tag = document.createElement('div');
                tag.className = "flex items-center gap-1 bg-white border border-orange-200 text-orange-700 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm animate-fade-in";
                tag.innerHTML = `${ing} <button onclick="toggleIngredient('${ing}')" class="text-orange-300 hover:text-red-500 ml-1"><i class="fa-solid fa-xmark"></i></button>`;
                box.appendChild(tag);
            });
        }

        // Sync Pool Colors & Input
        renderIngredientPool(document.getElementById('search-input').value);
        input.value = Array.from(state.selected).join(", ");
    }

    // --- GENERATE RECIPE ---
    async function generateRecipe() {
        const bahan = document.getElementById('final-ingredients').value;
        if (!bahan) return showToast("Pilih minimal satu bahan dulu ya!", "error");

        const mode = document.querySelector('input[name="mode"]:checked').value;

        // Switch View
        document.getElementById('state-placeholder').classList.add('hidden');
        document.getElementById('state-result').classList.add('hidden');
        document.getElementById('state-loading').classList.remove('hidden');
        document.getElementById('btn-generate').disabled = true;

        try {
            const res = await fetch('/api/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ bahan, mode })
            });
            const json = await res.json();

            if (res.ok && json.success) {
                renderResult(json.data.resep);
                state.lastRecipeId = json.data.history_id; // Simpan ID buat Fav
                resetFavButton();
                loadHistory(); // Refresh history list
                showToast("Resep berhasil dibuat!", "success");
            } else {
                if (res.status === 429) showToast("Sabar bos! Tunggu sebentar.", "error");
                else showToast(json.message || "Gagal membuat resep.", "error");
                document.getElementById('state-placeholder').classList.remove('hidden');
            }
        } catch (e) {
            console.error(e);
            showToast("Koneksi Error.", "error");
            document.getElementById('state-placeholder').classList.remove('hidden');
        } finally {
            document.getElementById('state-loading').classList.add('hidden');
            document.getElementById('btn-generate').disabled = false;
        }
    }

    function renderResult(text) {
        const box = document.getElementById('state-result');
        const content = document.getElementById('recipe-content');

        let html = text
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900">$1</strong>')
            .replace(/- (.*?)(<br>|$)/g, '<div class="flex gap-2 mb-1"><span class="text-orange-500">•</span> <span>$1</span></div>');

        content.innerHTML = html;
        box.classList.remove('hidden');

        // Auto scroll di mobile
        if(window.innerWidth < 1024) box.scrollIntoView({behavior: 'smooth'});
    }

    // --- HISTORY & FAVS ---
    async function loadHistory() {
        const container = document.getElementById('history-list');
        const empty = document.getElementById('history-empty');

        try {
            const res = await fetch('/api/history');
            const json = await res.json();

            if (json.success && json.data.length > 0) {
                empty.classList.add('hidden');
                container.innerHTML = "";

                json.data.reverse().forEach(item => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition group";
                    div.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-gray-800">${item.bahan_input}</h4>
                                <span class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded border">${new Date(item.created_at).toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm text-gray-500 line-clamp-2 mb-3">${item.resep_output.replace(/\*/g, '')}</p>
                            <div class="flex justify-between items-center mt-2 border-t pt-3 border-gray-50">
                                <button onclick="viewHistoryDetail('${encodeURIComponent(item.resep_output)}')" class="text-orange-600 text-sm font-semibold hover:underline">Lihat Resep</button>
                                ${item.is_favorite ? '<i class="fa-solid fa-heart text-red-500 animate-pulse"></i>' : ''}
                            </div>
                        `;
                    container.appendChild(div);
                });
            } else {
                empty.classList.remove('hidden');
                container.innerHTML = "";
            }
        } catch (e) {
            console.error("Gagal load history");
        }
    }

    function viewHistoryDetail(encText) {
        const text = decodeURIComponent(encText);
        document.getElementById('state-placeholder').classList.add('hidden');
        renderResult(text);
        // Hide fav button karena kita gak track ID history lama di view ini (simple version)
        document.getElementById('btn-fav').classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function toggleFavorite() {
        if (!state.lastRecipeId) return;
        const btn = document.getElementById('btn-fav');
        const icon = btn.querySelector('i');

        try {
            const res = await fetch('/api/favorites', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ history_id: state.lastRecipeId })
            });
            const json = await res.json();

            if (json.success) {
                if (json.data.is_favorite) {
                    icon.className = "fa-solid fa-heart text-xl text-red-500 transition transform scale-110";
                    btn.className = "h-10 w-10 rounded-full bg-red-50 border border-red-200 flex items-center justify-center text-red-500 shadow-sm";
                    showToast("Disimpan ke Favorit ❤️", "success");
                } else {
                    resetFavButton();
                    showToast("Dihapus dari Favorit", "info");
                }
                loadHistory(); // Refresh icon di list history
            }
        } catch (e) {
            showToast("Gagal update favorit", "error");
        }
    }

    function resetFavButton() {
        const btn = document.getElementById('btn-fav');
        const icon = btn.querySelector('i');
        btn.classList.remove('hidden');
        icon.className = "fa-regular fa-heart text-xl transition";
        btn.className = "h-10 w-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-400 hover:text-red-500 hover:border-red-200 hover:bg-red-50 transition shadow-sm";
    }

    // --- AUTH ---
    async function handleLogout() {
        await fetch('/api/logout');
        sessionStorage.clear();
        window.location.href = '/login';
    }

    // --- UTILS ---
    let toastTimeout;
    function showToast(msg, type) {
        const toast = document.getElementById('toast');
        const content = document.getElementById('toast-content');

        if (toastTimeout) clearTimeout(toastTimeout);

        content.innerText = msg;
        if (type === 'error') content.className = "px-6 py-4 rounded-lg shadow-xl text-white font-medium flex items-center gap-3 bg-red-500";
        else if (type === 'success') content.className = "px-6 py-4 rounded-lg shadow-xl text-white font-medium flex items-center gap-3 bg-green-500";
        else content.className = "px-6 py-4 rounded-lg shadow-xl text-white font-medium flex items-center gap-3 bg-blue-500";

        toast.classList.remove('translate-x-full');
        toastTimeout = setTimeout(() => toast.classList.add('translate-x-full'), 3000);
    }
</script>
</body>
</html>